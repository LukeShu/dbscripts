#!/bin/bash

. "$(dirname $0)/db-functions"
. "$(dirname $0)/config"

if [ $# -ne 3 ]; then
	msg "usage: $(basename $0) <pkgname|pkgbase> <repo> <arch>"
	exit 1
fi

pkgbase="$1"
repo="$2"
arch="$3"

ftppath="$FTP_BASE/$repo/os"
svnrepo="$repo-$arch"

if ! check_repo_permission $repo; then
	die "You don't have permission to remove packages from ${repo}"
fi

if [ "$arch" == "any" ]; then
	tarches=(${ARCHES[@]})
else
	tarches=("$arch")
fi

for tarch in ${tarches[@]}; do
	repo_lock $repo $tarch || exit 1
done

msg "Removing $pkgbase from [$repo]..."
/usr/bin/svn checkout -q "${SVNREPO}/${pkgbase}" "${WORKDIR}/svn/${pkgbase}" >/dev/null

if [ -d "${WORKDIR}/svn/$pkgbase/repos/$svnrepo" ]; then
	pkgnames=($(. "${WORKDIR}/svn/$pkgbase/repos/$svnrepo/PKGBUILD"; echo ${pkgname[@]}))
	/usr/bin/svn rm --force -q "${WORKDIR}/svn/$pkgbase/repos/$svnrepo"
	/usr/bin/svn commit -q "${WORKDIR}/svn/$pkgbase" -m "$(basename $0): $pkgbase removed by $(id -un)"
else
	warning "$pkgbase not found in $svnrepo"
	warning "Removing only $pkgbase from the repo"
	warning "If it was a split package you have to remove the others yourself!"
	pkgnames=($pkgbase)
fi

for tarch in ${tarches[@]}; do
	arch_repo_remove "${repo}" "${tarch}" ${pkgnames[@]}
	repo_unlock $repo $tarch
done
